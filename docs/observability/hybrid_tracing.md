# Hybrid Tracing Implementation Plan (OTel + Opik)

## Goal
Solve the "Split Brain" tracing issue where DBOS (using OpenTelemetry) and application code (using Opik SDK) generate disconnected traces. The goal is to have a single, unified trace in Opik where DBOS workflow spans are parents to the inner application method spans.

## The Strategy: Hybrid Context Injection
Instead of replacing the Opik SDK with raw OpenTelemetry (which would lose rich Opik features like feedback scores and token tracking), we will **bridge** the two systems.

1.  **Detect** the active OpenTelemetry Trace ID (generated by DBOS).
2.  **inject** this Trace ID into the Opik SDK's context using `opik_distributed_trace_headers`.
3.  **Result**: Opik spans will attach themselves to the existing DBOS trace.

## Proposed Changes

### Observability
#### [MODIFY] [src/observability.py](file:///Users/priya/Documents/tech/rag 101/src/observability.py)
- Refactor the `@track` decorator.
- Before calling `opik.track`, check `opentelemetry.trace.get_current_span()`.
- If a valid OTel span exists, extract its `trace_id` and `span_id`.
- Pass these IDs to the Opik decorator via the `opik_distributed_trace_headers` argument (hidden in `kwargs`).

### Ingestion Workflow
#### [MODIFY] [src/ingestion/workflow.py](file:///Users/priya/Documents/tech/rag 101/src/ingestion/workflow.py)
- Ensure `enable_otlp=True` and correct endpoint are set (already done).

### Configuration
#### [MODIFY] [scripts/run_ingestion_workflow.py](file:///Users/priya/Documents/tech/rag 101/scripts/run_ingestion_workflow.py)
- Ensure `OTEL_EXPORTER_OTLP_HEADERS` are set correctly (already done).

## Verification
1.  Run `scripts/run_ingestion_workflow.py`.
2.  Inspect the trace in Opik.
3.  **Success Criteria**:
    - The top-level span is the DBOS workflow (`ingest_folder_workflow`).
    - The inner spans (`embed_documents`, `chunk_documents`) appear **nested inside** the DBOS spans, not as separate traces.

## Appendix: Why Pure Opik Tracing Failed
We attempted to essentially "ignore" DBOS's OTel support and just use the `@track` decorator on everything (Workflows + Steps).

**The Result: "Split Brain" Tracing**
- We saw a trace for `ingest_folder_workflow` in Opik.
- We saw *separate, disconnected* traces for `embed_documents`, `chunk_documents`, etc.

**The Reason:**
1.  **Distributed Execution**: DBOS executes workflows and steps in different contexts (possibly different workers). Standard Python `contextvars` (which Opik uses to track "parent spans") are **not propagated** across these DBOS boundaries.
2.  **Context Loss**: When `ingest_folder_workflow` triggers `process_file_workflow`, the python context is lost. Opik sees `process_file_workflow` as a brand new root trace.
3.  **The Fix**: DBOS *does* propagate **OpenTelemetry** context. Our Hybrid approach bridges this by extracting the OTel context and manually feeding it back into Opik, stitching the trace back together.
